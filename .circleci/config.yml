# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs: 
  gcp-cli: circleci/gcp-cli@2.4.1

jobs:
  avocado:
    machine:
      image: ubuntu-2204:2022.07.1
    resource_class: large

    #docker:
    #  - image: cimg/node:18.7.0
    steps:
      - run:
          name: check python
          command: |
            pyenv versions
            pyenv global 2.7.18
            #which python3
            #export CLOUDSDK_PYTHON=/opt/circleci/.pyenv/shims/python3
            #pyenv install 3.9.9
            #pyenv global 3.9.9


      - checkout
      - gcp-cli/install
      - gcp-cli/initialize:
          gcloud-service-key: GCLOUD_SERVICE_KEY
          google-compute-region: AUSTRALIA_REGION
          #google-compute-zone: <<parameters.google-compute-zone>>
          google-project-id: GOOGLE_PROJECT_ID

      - run:
          name: configure kubectl
          command: |
            gcloud components install kubectl kustomize gke-gcloud-auth-plugin --quiet
            kubectl version --client
            gcloud version
            node --version
            npm --version


  production:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      - run:
          name: production deploy
          command: |
            echo production

workflows:
  avocado-workflow:
    jobs:
      - avocado
      - production:
          requires:
            - avocado
          filters:
            branches:
              only:
                - master      

